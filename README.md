# AWS Dev: EC2 + Postgres (RDS) + Redis + Amazon MQ (RabbitMQ) + S3 (Java smoke)

## Prereqs
- AWS CLI v2 configured (MFA/SSO or keys)
- Terraform v1.6+
- Java 17+ & Maven

## Getting started (developers)
1) Fill in variables
	 - Copy `infra/terraform/terraform.tfvars.example` to `infra/terraform/terraform.tfvars`
	 - Edit values (no passwords required):
		 - `project` (e.g., "starter"), `env` (e.g., "dev"), `region` (e.g., "ap-southeast-2")
		 - `rds_username` (e.g., "appuser"), `rds_db_name` (e.g., "appdb")
		 - `rabbit_user` (e.g., "app")
	 - Optional: set `aws_profile` if not using the default CLI profile

2) Provision infrastructure
```powershell
cd infra/terraform
terraform init
terraform validate
terraform plan -out tfplan
terraform apply tfplan
terraform output
```

Notes on secrets:
- RDS master password is generated by AWS and stored in Secrets Manager (no tfvars password).
- RabbitMQ password is generated by Terraform and stored in Secrets Manager at `dev/rabbitmq/app`.

## Connect to EC2
- Console → EC2 → Connect → **Session Manager**
- Or CLI: `aws ssm start-session --target <INSTANCE_ID>`

## Local development (port-forwarded DB/Redis/MQ)
Use SSM port-forwarding to reach private services from your laptop, then run the smoke test locally.

1) Start tunnels (each in its own terminal):
```powershell
scripts/ssm_port_forward_db.ps1 -InstanceId <EC2_INSTANCE_ID>
scripts/ssm_port_forward_redis.ps1 -InstanceId <EC2_INSTANCE_ID>
scripts/ssm_port_forward_rabbitmq.ps1 -InstanceId <EC2_INSTANCE_ID>
```

2) Run the local smoke helper (sets env vars from terraform outputs and runs the app):
```powershell
scripts/local_dev_run.ps1
```
The script prints the EC2 instance id and the exact port-forward commands if you haven’t started them yet.

## Build & run Java smoke (EC2 or local)
- On EC2 (no port forwarding needed; env is injected by user_data):
```bash
cd /home/ec2-user/AWSSmokeTest/apps/hello-service-java
mvn -q -DskipTests package
java -cp target/hello-service-0.1.0.jar App
```
- Locally (requires tunnels as above): use `scripts/local_dev_run.ps1` or run manually:
```powershell
cd apps/hello-service-java
mvn -q -DskipTests package
java -cp target/hello-service-0.1.0.jar App
```
Expected output:
- Postgres insert OK
- Redis counter value
- RabbitMQ publish OK
- S3 put/get OK

## Destroy
```sh
cd infra/terraform && terraform destroy -auto-approve
```
